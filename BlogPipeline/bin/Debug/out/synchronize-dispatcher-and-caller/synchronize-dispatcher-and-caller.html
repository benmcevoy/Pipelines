<p>More Windows Phone/Silverlight/WPF/(and probably WinRT) goodness.</p>

<p>Sometimes you want to know that any work pushed to the UI dispatcher has completed.  For awhile I worked with the idea that <a href="http://msdn.microsoft.com/en-us/library/d00bd51t(v=vs.95).aspx">Thread.Sleep(1)</a> would let any pending work complete. It doesn't.</p>

<p><a href="http://stackoverflow.com/questions/9453553/windows-phone-how-to-tell-when-deployment-current-dispatcher-begininvoke-has-co">A much better approach</a> is to use some <a href="http://msdn.microsoft.com/en-us/library/system.threading.autoresetevent(v=vs.95).aspx">thread signalling</a>. The calling thread will wait until the dispatched work has completed, or give up after some period.</p>

<pre class='prettyprint'><code>

        private static void WaitWithDispatcher(Action action)
        {
            if (Deployment.Current.Dispatcher.CheckAccess())
            {
                action();
                return;
            }

            var wait = new AutoResetEvent(false);

            Deployment.Current.Dispatcher.BeginInvoke(() =>
            {
                try
                {
                    action();
                }
                finally
                {
                    // always signal so code can continue
                    wait.Set();
                }
            });

            // wait for a reasonable period for dispatcher to complete
            wait.WaitOne(TimeSpan.FromSeconds(10));
        }

        private static void WithDispatcher(Action action)
        {
            if (Deployment.Current.Dispatcher.CheckAccess())
            {
                action();
                return;
            }

            Deployment.Current.Dispatcher.BeginInvoke(action);
        }

</code></pre>
